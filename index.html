<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SmartThings Controller</title>
<style>
  /* Reset and base */
  * {
    box-sizing: border-box;
  }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f0f4ff;
    margin: 2rem auto;
    max-width: 480px;
    padding: 1rem 2rem 3rem 2rem;
    color: #222;
  }
  h1 {
    text-align: center;
    color: #1e40af;
    margin-bottom: 1.5rem;
  }
  button, select {
    font-size: 1rem;
    padding: 0.5rem 1.2rem;
    margin-top: 0.5rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  button {
    background-color: #2563eb;
    color: white;
    box-shadow: 0 3px 6px rgba(37, 99, 235, 0.3);
  }
  button:hover:not(:disabled) {
    background-color: #1e40af;
  }
  button:disabled {
    background-color: #a5b4fc;
    cursor: not-allowed;
    box-shadow: none;
  }
  select {
    width: 100%;
    background: white;
    border: 1.5px solid #bbb;
    border-radius: 6px;
    padding: 0.5rem 0.8rem;
    color: #333;
  }
  label {
    font-weight: 600;
    display: block;
    margin-top: 1rem;
    margin-bottom: 0.3rem;
  }
  #selectors {
    background: white;
    padding: 1rem 1.5rem;
    border-radius: 10px;
    box-shadow: 0 6px 12px rgb(0 0 0 / 0.1);
  }
  #controlButtons {
    margin-top: 1.5rem;
    text-align: center;
  }
  #controlButtons button {
    margin: 0 0.5rem;
    min-width: 80px;
  }
  #status, #error, #currentState {
    margin-top: 1rem;
    padding: 0.8rem 1rem;
    border-radius: 8px;
    font-weight: 600;
    user-select: none;
  }
  #status {
    background: #d1fae5;
    color: #065f46;
  }
  #error {
    background: #fee2e2;
    color: #b91c1c;
  }
  #currentState {
    background: #e0e7ff;
    color: #3730a3;
    line-height: 1.5;
  }
  #currentState span.label {
    font-weight: 700;
    margin-right: 0.5rem;
  }
</style>
</head>
<body>

<h1>SmartThings Controller</h1>

<button id="scanBtn">Scan Devices & Scenes</button>

<div id="selectors" style="display:none;">
  <label for="deviceSelect">Select Device:</label>
  <select id="deviceSelect">
    <option value="">-- Select device --</option>
  </select>

  <label for="sceneSelect">Select Scene:</label>
  <select id="sceneSelect">
    <option value="">-- Select scene --</option>
  </select>
</div>

<div id="controlButtons" style="display:none;">
  <button id="btnOn" disabled>On</button>
  <button id="btnOff" disabled>Off</button>
  <button id="btnExecute" style="display:none;">Execute Scene</button>
</div>

<div id="currentState" style="display:none;">
  <div><span class="label">Health Status:</span><span id="healthStatus">N/A</span></div>
  <div><span class="label">Switch Status:</span><span id="switchStatus">N/A</span></div>
</div>

<div id="status" style="display:none;"></div>
<div id="error" style="display:none;"></div>

<script>
  const WORKER_URL = "https://smarthome-silver.monzer-mohamad-a.workers.dev";

  const scanBtn = document.getElementById('scanBtn');
  const deviceSelect = document.getElementById('deviceSelect');
  const sceneSelect = document.getElementById('sceneSelect');
  const selectorsDiv = document.getElementById('selectors');
  const controlButtonsDiv = document.getElementById('controlButtons');
  const btnOn = document.getElementById('btnOn');
  const btnOff = document.getElementById('btnOff');
  const btnExecute = document.getElementById('btnExecute');
  const statusDiv = document.getElementById('status');
  const errorDiv = document.getElementById('error');
  const currentStateDiv = document.getElementById('currentState');
  const healthStatusSpan = document.getElementById('healthStatus');
  const switchStatusSpan = document.getElementById('switchStatus');

  let currentSelection = { type: null, id: null };

  scanBtn.onclick = async () => {
    clearMessages();
    showStatus('Scanning devices and scenes...');
    try {
      const [devicesRes, scenesRes] = await Promise.all([
        fetch(`${WORKER_URL}/devices`),
        fetch(`${WORKER_URL}/scenes`)
      ]);

      if (!devicesRes.ok) throw new Error('Failed to fetch devices');
      if (!scenesRes.ok) throw new Error('Failed to fetch scenes');

      const devicesData = await devicesRes.json();
      const scenesData = await scenesRes.json();

      deviceSelect.innerHTML = '<option value="">-- Select device --</option>';
      devicesData.items.forEach(device => {
        const name = device.label || device.name || "Unnamed Device";
        deviceSelect.innerHTML += `<option value="${device.deviceId}">${escapeHtml(name)}</option>`;
      });

      sceneSelect.innerHTML = '<option value="">-- Select scene --</option>';
      scenesData.items.forEach(scene => {
        const name = scene.sceneName || scene.name || "Unnamed Scene";
        sceneSelect.innerHTML += `<option value="${scene.sceneId}">${escapeHtml(name)}</option>`;
      });

      selectorsDiv.style.display = 'block';
      controlButtonsDiv.style.display = 'none';
      currentStateDiv.style.display = 'none';
      showStatus('Scan complete. Select a device or scene.');
    } catch (err) {
      showError('Error scanning devices/scenes: ' + err.message);
      selectorsDiv.style.display = 'none';
      controlButtonsDiv.style.display = 'none';
      currentStateDiv.style.display = 'none';
    }
  };

  function resetControlButtons() {
    btnOn.disabled = true;
    btnOff.disabled = true;
    btnExecute.style.display = 'none';
    controlButtonsDiv.style.display = 'none';
    currentStateDiv.style.display = 'none';
  }

  deviceSelect.onchange = async () => {
    clearMessages();
    if (deviceSelect.value) {
      if (sceneSelect.value) sceneSelect.value = "";
      currentSelection = { type: 'device', id: deviceSelect.value };

      btnOn.disabled = false;
      btnOff.disabled = false;
      btnExecute.style.display = 'none';
      controlButtonsDiv.style.display = 'block';

      await fetchDeviceStatus(currentSelection.id);
    } else {
      currentSelection = { type: null, id: null };
      resetControlButtons();
    }
  };

  sceneSelect.onchange = () => {
    clearMessages();
    if (sceneSelect.value) {
      if (deviceSelect.value) deviceSelect.value = "";
      currentSelection = { type: 'scene', id: sceneSelect.value };

      btnOn.disabled = true;
      btnOff.disabled = true;
      btnExecute.style.display = 'inline-block';
      controlButtonsDiv.style.display = 'block';

      currentStateDiv.style.display = 'none';
    } else {
      currentSelection = { type: null, id: null };
      resetControlButtons();
    }
  };

  async function fetchDeviceStatus(deviceId) {
    currentStateDiv.style.display = 'block';
    healthStatusSpan.textContent = 'Loading...';
    switchStatusSpan.textContent = 'Loading...';

    try {
      const res = await fetch(`${WORKER_URL}/device-status?id=${encodeURIComponent(deviceId)}`);
      if (!res.ok) throw new Error('Failed to fetch device status');
      const data = await res.json();

      // Default values
      let healthStatus = "Unknown";
      let switchStatus = "Unknown";

      if (data.components && data.components.main) {
        // Health Status
        if (data.components.main.healthCheck && data.components.main.healthCheck["DeviceWatch-DeviceStatus"] && data.components.main.healthCheck["DeviceWatch-DeviceStatus"].value) {
          healthStatus = data.components.main.healthCheck["DeviceWatch-DeviceStatus"].value;
        }
        // Switch Status
        if (data.components.main.switch && data.components.main.switch.switch && data.components.main.switch.switch.value) {
          switchStatus = data.components.main.switch.switch.value;
        }
      }

      // Capitalize first letter
      healthStatusSpan.textContent = capitalizeFirst(healthStatus);
      switchStatusSpan.textContent = capitalizeFirst(switchStatus);
    } catch (err) {
      healthStatusSpan.textContent = 'Error';
      switchStatusSpan.textContent = 'Error';
      showError('Error fetching device status: ' + err.message);
    }
  }

  async function sendControlCommand(command) {
    if (!currentSelection.type || !currentSelection.id) {
      showError('Please select a device or scene first.');
      return;
    }
    clearMessages();
    showStatus('Sending command...');

    let body;
    if (currentSelection.type === 'device') {
      body = {
        type: 'device',
        id: currentSelection.id,
        command: command
      };
    } else {
      body = {
        type: 'scene',
        id: currentSelection.id
      };
    }

    try {
      const res = await fetch(`${WORKER_URL}/control`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      if (!res.ok) throw new Error('Failed to send command');
      await res.json();
      showStatus('Command sent successfully.');

      // Refresh device status if device controlled
      if (currentSelection.type === 'device') {
        await fetchDeviceStatus(currentSelection.id);
      }
    } catch (err) {
      showError('Error sending command: ' + err.message);
    }
  }

  btnOn.onclick = () => sendControlCommand('on');
  btnOff.onclick = () => sendControlCommand('off');
  btnExecute.onclick = () => sendControlCommand();

  function clearMessages() {
    statusDiv.style.display = 'none';
    statusDiv.textContent = '';
    errorDiv.style.display = 'none';
    errorDiv.textContent = '';
  }
  function showStatus(msg) {
    statusDiv.style.display = 'block';
    statusDiv.textContent = msg;
  }
  function showError(msg) {
    errorDiv.style.display = 'block';
    errorDiv.textContent = msg;
    statusDiv.style.display = 'none';
    statusDiv.textContent = '';
  }
  function capitalizeFirst(str) {
    if (!str) return '';
    return str.charAt(0).toUpperCase() + str.slice(1);
  }
  function escapeHtml(text) {
    return text.replace(/[&<>"']/g, function(m) {
      return ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      })[m];
    });
  }

  resetControlButtons();
</script>

</body>
</html>
